import React, { useEffect, useState } from 'react';
import { API_BASE_URL } from '../../config';
import { useAuth } from '../../contexts/AuthContext';
import Button from '../UI/Button';

const STATUS_OPTIONS = ['Pending', 'Approved', 'Rejected', 'Completed'];

const BookingsTab = () => {
  const { user } = useAuth();
  const [bookings, setBookings] = useState([]);
  const [amenities, setAmenities] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [statusEdit, setStatusEdit] = useState({}); // { [bookingId]: status }

  const getAuthHeaders = () => ({
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  });

  const fetchBookings = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_BASE_URL}/bookings`, { headers: getAuthHeaders() });
      if (!res.ok) throw new Error('Failed to load bookings');
      const data = await res.json();
      setBookings(data);
    } catch {
      setError('Failed to load bookings');
    }
    setLoading(false);
  };

  const fetchAmenities = async () => {
    try {
      const res = await fetch(`${API_BASE_URL}/amenities`, { headers: getAuthHeaders() });
      if (!res.ok) throw new Error('Failed to load amenities');
      const data = await res.json();
      setAmenities(data);
    } catch {
      setAmenities([]);
    }
  };

  useEffect(() => { fetchBookings(); fetchAmenities(); }, []);

  const handleStatusChange = (bookingId, status) => {
    setStatusEdit(prev => ({ ...prev, [bookingId]: status }));
  };

  const handleStatusUpdate = async (booking) => {
    const newStatus = statusEdit[booking.bookingId] || booking.status;
    if (newStatus === booking.status) return;
    setLoading(true);
    try {
      // Only send fields required for update
      const payload = {
        status: newStatus,
        paid: booking.paid,
        transactionId: booking.transactionId,
        userId: booking.userId,
        flatId: booking.flatId,
        amenityId: booking.amenityId,
        createdAt: booking.createdAt,
        startDate: booking.startDate,
        endDate: booking.endDate,
        startTime: booking.startTime,
        endTime: booking.endTime,
        amount: booking.amount
      };
      const res = await fetch(`${API_BASE_URL}/bookings/${booking.bookingId}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Failed to update status');
      fetchBookings();
    } catch {
      setError('Failed to update status');
    }
    setLoading(false);
  };

  return (
    <div>
      <h2 className="text-lg font-semibold mb-4">Amenity Bookings</h2>
      {error && <div className="text-red-600 mb-2">{error}</div>}
      <div className="overflow-x-auto">
        <table className="min-w-full border text-sm">
          <thead>
            <tr className="bg-gray-100">
              <th className="px-4 py-2 border">Booking ID</th>
              <th className="px-4 py-2 border">Amenity</th>
              <th className="px-4 py-2 border">User ID</th>
              <th className="px-4 py-2 border">Date</th>
              <th className="px-4 py-2 border">Start Time</th>
              <th className="px-4 py-2 border">End Time</th>
              <th className="px-4 py-2 border">Status</th>
              <th className="px-4 py-2 border">Actions</th>
            </tr>
          </thead>
          <tbody>
            {bookings.map(b => {
              const amenity = amenities.find(a => a.amenityId === b.amenityId);
              return (
                <tr key={b.bookingId}>
                  <td className="border px-4 py-2">{b.bookingId}</td>
                  <td className="border px-4 py-2">{amenity ? amenity.name : b.amenityId}</td>
                  <td className="border px-4 py-2">{b.userId}</td>
                  <td className="border px-4 py-2">{b.startDate}</td>
                  <td className="border px-4 py-2">{b.startTime}</td>
                  <td className="border px-4 py-2">{b.endTime}</td>
                  <td className="border px-4 py-2">
                    <select
                      value={statusEdit[b.bookingId] || b.status}
                      onChange={e => handleStatusChange(b.bookingId, e.target.value)}
                      className="border rounded px-2 py-1"
                      disabled={b.status === 'Cancelled'}
                    >
                      {STATUS_OPTIONS.map(opt => (
                        <option key={opt} value={opt}>{opt}</option>
                      ))}
                    </select>
                  </td>
                  <td className="border px-4 py-2">
                    <Button
                      type="button"
                      variant="primary"
                      size="sm"
                      disabled={b.status === 'Cancelled' || (statusEdit[b.bookingId] || b.status) === b.status}
                      onClick={() => handleStatusUpdate(b)}
                    >
                      Update
                    </Button>
                  </td>
                </tr>
              );
            })}
            {bookings.length === 0 && (
              <tr><td colSpan={8} className="text-center py-4">No bookings found.</td></tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default BookingsTab;
